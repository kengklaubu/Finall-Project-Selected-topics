<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ</title>
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #333;
            color: white;
            padding: 10px 20px;
        }

        .header .logo {
            display: flex;
            align-items: center;
        }

        .header .logo img {
            height: 40px;
            margin-right: 10px;
        }

        .header .logo h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header .nav-menu a {
            color: white;
            text-decoration: none;
            margin-right: 15px;
            font-size: 1rem;
        }

        .header .nav-menu a:hover {
            text-decoration: underline;
        }

        .header .user-icon img {
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
        }

        .container {
            padding: 20px;
        }

        .map-container {
            margin-bottom: 20px;
        }

        .map-container img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <!-- Header Section -->
    <div class="header">
        <div class="logo">
            <img src="{% static 'easypark/image/logo.png' %}" alt="Easy Parking Logo">
            <h1>Easy Parking</h1>
        </div>
        <div class="nav-menu">
            <a href="{% url 'homepage' %}">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>
        <div class="user-icon">
            <a href="{% url 'profile' %}">
                <img src="{% static 'easypark/image/user_1.png' %}" alt="User Icon">
            </a>
        </div>
    </div>
    </div>
    <style>
        .container {
            display: flex;
            justify-content: space-around;
            margin: 20px;
            padding: 10px;
        }

        .map-container {
            flex: 1;
            margin-right: 20px;
        }

        .map-container img {
            width: 100%;
            max-width: 550px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .parking-spot {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin: 5px;
            background-color: grey;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border-radius: 15px;
        }

        .back-button {
            text-align: right;
            margin-top: 20px;
        }

        .back-button a {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
        }

        .back-button a:hover {
            background-color: #45a049;
        }

        #details-container {
            display: none;
            /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 400px;
            max-width: 80%;
        }

        .modal-overlay {
            display: none;
            /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            background-color: red;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
        }

        .close-btn:hover {
            background-color: darkred;
        }

        .reserve-btn {
            background-color: #4CAF50;
            /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .reserve-btn:hover {
            background-color: #45a049;
            transform: scale(1.05);

        }

        .reserve-btn:active {
            transform: scale(0.95);

        }

        .reserve-btn:disabled {
            background-color: grey;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>

    <!-- ‡πÉ‡∏™‡πà Modal Overlay ‡πÅ‡∏•‡∏∞ Details Container ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î </body> -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;"></div>
    <div id="details-container" class="details-container"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
    </div>





    <div class="flex w-full justify-around">
        <!-- ‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ) -->
        <div class="w-1/2 mt-8 max-w-2xl mx-auto bg-gray-300 p-6 rounded-lg shadow-xl">
            <svg id="parking-map" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 300" width="100%" height="100%">
                <image href="{{location.image.url}}" x_position="0" y_position="0" width="500" height="300" />
                {% for spot in spots %}
                <g id="spot-{{ spot.id }}" data-spot-id="{{ spot.id }}"
                    onclick="showSpotDetails(this.getAttribute('data-spot-id'))">
                    <!-- Path ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏ß‡πà‡∏≤‡∏á) -->
                    <path id="spot-path-green-{{ spot.id }}" fill="#22db14"
                        d="M64 80c-8.8 0-16 7.2-16 16l0 320c0 8.8 7.2 16 16 16l320 0c8.8 0 16-7.2 16-16l0-320c0-8.8-7.2-16-16-16L64 80zM0 96C0 60.7 28.7 32 64 32l320 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"
                        transform="translate({{ spot.x_position }}, {{ spot.y_position }}) scale(0.05)">
                    </path>
                    <!-- Path ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á) -->
                    <path id="spot-path-red-{{ spot.id }}" fill="#ff0000" style="display: none;"
                        d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c-9.4 9.4-9.4 24.6 0 33.9l47 47-47 47c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l47-47 47 47c-9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-47-47 47-47c-9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-47 47-47-47c-9.4-9.4-24.6-9.4-33.9 0z"
                        transform="translate({{ spot.x_position }}, {{ spot.y_position }}) scale(0.05)">
                    </path>
                </g>
                {% endfor %}
            </svg>
        </div>

        <!-- ‡∏ù‡∏±‡πà‡∏á Live Camera Feed -->
        <div class="w-1/2 mt-8 max-w-2xl mx-auto bg-gray-300 p-6 rounded-lg shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Live Camera Feed</h2>
            <div class="mb-6">
                <label for="location-select" class="block text-base font-medium text-gray-600 mb-2">Select
                    Location:</label>
                <select id="location-select"
                    class="block w-full border-gray-300 rounded-md shadow-sm p-3 text-gray-700">
                    <option value="">Select a location</option>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}" {% if loc == location %} selected {% endif %}>{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Live Stream -->
            <div class="overflow-hidden rounded-lg border border-gray-400 bg-gray-200">
                <img id="live-stream" class="w-full h-80 object-cover" src="" alt="Live Stream">
            </div>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const liveStream = document.getElementById('live-stream');
            const locationSelect = document.getElementById('location-select');

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default stream
            const defaultStream = `/live/{{ location.id }}/`;
            liveStream.src = defaultStream;

            locationSelect.addEventListener('change', function () {
                const locationId = this.value;
                liveStream.src = locationId ? `/live/${locationId}/` : defaultStream;
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
            fetchParkingStatus();
        });

        function fetchParkingStatus() {
            console.log("Fetching parking status...");
            const locationId = document.getElementById('location-select').value || "{{ location.id }}";

            $.ajax({
                url: "{% url 'get_parking_status' %}",
                method: "GET",
                data: { location_id: locationId },
                success: function (data) {
                    console.log("üöó Parking status fetched:", data);

                    data.forEach(function (spot) {
                        console.log("üìå Spot data:", spot); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ spot.id ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        console.log(`üîç Looking for #spot-${spot.id}`);

                        const pathGreen = document.querySelector(`#spot-path-green-${spot.id}`);
                        const pathRed = document.querySelector(`#spot-path-red-${spot.id}`);

                        if (!spot.id) {
                            console.error(`‚ùå spot.id is undefined for`, spot);
                            return;
                        }

                        if (!pathGreen || !pathRed) {
                            console.warn(`‚ùå Path elements for spot-${spot.id} not found.`);
                            return;
                        }

                        // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á path ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ
                        if (spot.is_available) {
                            pathGreen.style.display = "block";  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                            pathRed.style.display = "none";     // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        } else {
                            pathGreen.style.display = "none";   // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                            pathRed.style.display = "block";    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        }
                    });
                },

                error: function () {
                    console.error("‚ùå Error fetching parking status");
                }
            });
        }

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(fetchParkingStatus, 2000);



        function showSpotDetails(spotId) {
            console.log(`üñ±Ô∏è Clicked Spot ID: ${spotId}`);

            if (!spotId) {
                console.error("Spot ID is missing!");
                return;
            }

            const locationId = document.getElementById('location-select').value || "{{ location.id }}";

            console.log("Fetching details for Location ID:", locationId, "Spot ID:", spotId);

            $.ajax({
                url: "{% url 'get_spot_details' %}",
                method: "GET",
                data: { location_id: locationId, spot_id: spotId },
                success: function (data) {
                    console.log("Spot details fetched:", data);

                    const detailsContainer = document.getElementById("details-container");
                    if (!detailsContainer) {
                        console.error("details-container not found in DOM!");
                        return;
                    }

                    detailsContainer.innerHTML = `
                <h3>‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≠‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${data.spot_number}</h3> <!-- ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å data.id ‡πÄ‡∏õ‡πá‡∏ô data.spot_number -->
                <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${data.is_available ? "‡∏ß‡πà‡∏≤‡∏á" : "‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á"}</p>
                <p>‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢: ${data.reserved_by || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}</p>
                ${data.is_available ? `<button class="reserve-btn" onclick="goToReservePage(${data.spot_number})">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>` : `<p style="color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>`}
                <button class="close-btn" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
            `;

                    showModal();
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching spot details:", xhr.responseText);
                }
            });
        }




        function goToReservePage(spotNumber) {
            const locationId = document.getElementById('location-select').value || "{{ location.id }}";
            window.location.href = `/reserve_page/${spotNumber}/?location_id=${locationId}`;
        }


        function showModal() {
            document.getElementById("modal-overlay").style.display = "block";
            document.getElementById("details-container").style.display = "block";
        }

        function closeModal() {
            document.getElementById("modal-overlay").style.display = "none";
            document.getElementById("details-container").style.display = "none";
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(fetchParkingStatus, 2000);
    </script>




</body>

</html>